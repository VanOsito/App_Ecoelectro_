<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="App.Views.CameraResultPage"
             Title="Resultado de Cámara"
             BackgroundColor="#DCCAE6">

    <Grid RowDefinitions="Auto, *" Padding="12" RowSpacing="10">

        <!-- 0: Preview y controles -->
        <VerticalStackLayout Grid.Row="0" Padding="8" Spacing="8">
            <Image x:Name="Preview" HeightRequest="240" Aspect="AspectFit" />

            <!-- Activity + resultado en una fila -->
            <HorizontalStackLayout Spacing="8" VerticalOptions="Center" HorizontalOptions="Center">
                <ActivityIndicator x:Name="Busy" IsVisible="False" IsRunning="False" />
                <Label x:Name="ResultLabel" FontSize="16" VerticalOptions="Center" TextColor="#7F4A9B"/>
            </HorizontalStackLayout>

            <!-- Botón debajo, centrado -->
            <Button x:Name="BtnClassifyAgain"
              Text="Clasificar de nuevo"
              Clicked="OnClassifyAgain"
              HorizontalOptions="Center"
              Margin="0,6,0,0"/>
        </VerticalStackLayout>

        <!-- 1: Lista agrupada por componente (CollectionView como scroll principal) -->
        <CollectionView x:Name="GroupedList"
                    Grid.Row="1"
                    ItemsSource="{Binding ComponentGroups}"
                    SelectionMode="None"
                    Margin="0,6,0,0"
                    EmptyView="No se encontraron componentes.">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Padding="10" Margin="0,6,0,6" CornerRadius="8" BorderColor="#E0E0E0" HasShadow="False">
                        <VerticalStackLayout Spacing="8">

                            <!-- Datos del componente -->
                            <Label Text="{Binding Component.Nombre}" FontAttributes="Bold" FontSize="18" TextColor="#7F4A9B"/>
                            <Label Text="{Binding Component.Estado}" TextColor="Gray" FontSize="14" />
                            <Label Text="{Binding Component.Descripcion}" FontSize="13" LineBreakMode="TailTruncation" TextColor="#7F4A9B"/>

                            <!-- Subtítulo -->
                            <Label Text="Lugares donde puedes reciclar:" FontAttributes="Italic" Margin="0,6,0,2" TextColor="#7F4A9B"/>

                            <!-- Lista de empresas (sin scroll interno) -->
                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Companies}" Spacing="6">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate>
                                        <Frame Padding="8" HasShadow="False" BorderColor="#DCCAE6" CornerRadius="6">
                                            <VerticalStackLayout Spacing="4">
                                                <Label Text="{Binding Nombre}" FontAttributes="Bold" TextColor="#7F4A9B"/>

                                                <!-- Teléfono: toca para copiar -->
                                                <Label Text="{Binding Telefono}"
                                                       IsVisible="{Binding Telefono, Converter={StaticResource NullToBool}}"
                                                       TextColor="#007AFF"
                                                       TextDecorations="Underline"
                                                       LineBreakMode="TailTruncation">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnPhoneTapped" NumberOfTapsRequired="1" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <!-- Correo: toca para copiar -->
                                                <Label Text="{Binding Email}"
                                                       IsVisible="{Binding Email, Converter={StaticResource NullToBool}}"
                                                       TextColor="#007AFF"
                                                       TextDecorations="Underline"
                                                       LineBreakMode="TailTruncation">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnEmailTapped" NumberOfTapsRequired="1" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <!-- Website: toca para abrir en navegador -->
                                                <Label Text="{Binding Website}"
                                                       IsVisible="{Binding Website, Converter={StaticResource NullToBool}}"
                                                       TextColor="#007AFF"
                                                       TextDecorations="Underline"
                                                       LineBreakMode="TailTruncation">
                                                    <Label.GestureRecognizers>
                                                        <TapGestureRecognizer Tapped="OnWebsiteTapped" NumberOfTapsRequired="1" />
                                                    </Label.GestureRecognizers>
                                                </Label>

                                                <Label Text="{Binding CoverageNotes}" FontSize="12" TextColor="Gray" LineBreakMode="TailTruncation" />
                                            </VerticalStackLayout>
                                        </Frame>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</ContentPage>