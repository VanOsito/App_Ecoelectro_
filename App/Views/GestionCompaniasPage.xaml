<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="App.Views.GestionCompaniasPage"
             Title="Gestión de las compañias"
             BackgroundColor="#DCCAE6">
    <ContentPage.Resources>
        <Style TargetType="Label">
            <Setter Property="FontSize" Value="14" />
        </Style>
        <Style TargetType="Entry">
            <Setter Property="FontSize" Value="14" />
        </Style>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="12">

        <!-- Barra superior -->
        <Grid ColumnDefinitions="*,Auto,Auto" Margin="0,0,0,8">
            <SearchBar Grid.Column="0"
                       Placeholder="Buscar compañía..."
                       x:Name="SearchBox"
                       TextChanged="OnSearchTextChanged" />
            <Button Grid.Column="1" Text="Refrescar" Clicked="OnRefreshClicked" Margin="8,0"/>
            <Button Grid.Column="2" Text="Nueva" Clicked="OnNewCompany" />
        </Grid>

        <!-- Cuerpo: lista + formulario -->
        <Grid Grid.Row="1" ColumnDefinitions="1.2*,1.8*" ColumnSpacing="16">

            <!-- LISTA -->
            <CollectionView Grid.Column="0"
                            x:Name="CompaniesList"
                            ItemsSource="{Binding Companies}"
                            SelectionMode="Single">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="10" Margin="0,6" HasShadow="False" BorderColor="#ddd">
                            <!-- Tap garantizado en todo el frame -->
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCompanyTapped" NumberOfTapsRequired="1" />
                            </Frame.GestureRecognizers>

                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding Nombre}"
                                       FontSize="16"
                                       FontAttributes="Bold" TextColor="#7F4A9B"/>
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding ActivoLabel}"
                                       TextColor="{Binding ActivoColor}" />

                                <StackLayout Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="12">
                                    <Label Text="{Binding CoberturasResumen}" TextColor="#7F4A9B" />
                                    <Label Text="•" TextColor="#7F4A9B"/>
                                    <Label Text="{Binding ComponentesResumen}" TextColor="#7F4A9B"/>
                                </StackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- FORMULARIO -->
            <ScrollView Grid.Column="1">
                <VerticalStackLayout Spacing="10">

                    <Label Text="Editar / Crear compañía" FontSize="18" FontAttributes="Bold"/>

                    <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                        <Label Grid.Row="0" Grid.Column="0" Text="Nombre*" TextColor="#7F4A9B"/>
                        <Entry Grid.Row="0" Grid.Column="1" Text="{Binding Editing.Nombre}" Placeholder="Nombre de la compañía"/>

                        <Label Grid.Row="1" Grid.Column="0" Text="Website" TextColor="#7F4A9B"/>
                        <Entry Grid.Row="1" Grid.Column="1" Text="{Binding Editing.Website}" Placeholder="https://..."/>

                        <Label Grid.Row="2" Grid.Column="0" Text="Teléfono" TextColor="#7F4A9B"/>
                        <Entry Grid.Row="2" Grid.Column="1" Text="{Binding Editing.Telefono}" Placeholder="+56 9 ..."/>

                        <Label Grid.Row="3" Grid.Column="0" Text="Email" TextColor="#7F4A9B" />
                        <Entry Grid.Row="3" Grid.Column="1" Text="{Binding Editing.Email}" Placeholder="contacto@empresa.cl"/>

                        <Label Grid.Row="4" Grid.Column="0" Text="Notas" TextColor="#7F4A9B"/>
                        <Entry Grid.Row="4" Grid.Column="1" Text="{Binding Editing.CoverageNotes}" Placeholder="Notas de cobertura..."/>

                        <Label Grid.Row="5" Grid.Column="0" Text="Activo" TextColor="#7F4A9B"/>
                        <Switch Grid.Row="5" Grid.Column="1" IsToggled="{Binding Editing.Active}" />

                    </Grid>

                    <BoxView HeightRequest="1" Color="#e0e0e0" />

                    <!-- COBERTURAS -->
                    <Label Text="Coberturas" FontAttributes="Bold" TextColor="#7F4A9B"/>
                    <Grid ColumnDefinitions="*,*,Auto" ColumnSpacing="8">
                        <Picker x:Name="RegionPicker"
                                Title="Región"
                                ItemsSource="{Binding Regiones}"
                                SelectedIndexChanged="OnRegionChanged"/>
                        <Picker Grid.Column="1"
                                x:Name="ComunaPicker"
                                Title="Comuna (opcional)"/>
                        <Button Grid.Column="2" Text="Agregar" Clicked="OnAddCoverage"/>
                    </Grid>

                    <CollectionView ItemsSource="{Binding Coberturas}" Margin="0,4,0,0">
                        <CollectionView.Header>
                            <Grid ColumnDefinitions="*,*" Padding="4,0">
                                <Label Text="Región" FontAttributes="Bold"/>
                                <Label Grid.Column="1" Text="Comuna" FontAttributes="Bold"/>
                            </Grid>
                        </CollectionView.Header>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,*,Auto" Padding="4">
                                    <Label Text="{Binding Region}" />
                                    <Label Grid.Column="1" Text="{Binding Comuna}" />
                                    <Button Grid.Column="2" Text="Quitar" Clicked="OnRemoveCoverage" CommandParameter="{Binding .}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <BoxView HeightRequest="1" Color="#e0e0e0" />

                    <!-- COMPONENTES -->
                    <Label Text="Componentes que atiende" FontAttributes="Bold" TextColor="#7F4A9B"/>
                    <CollectionView ItemsSource="{Binding Componentes}" x:Name="ComponentesList">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*" Padding="4,2">
                                    <CheckBox IsChecked="{Binding IsSelected}" />
                                    <Label Grid.Column="1" Text="{Binding Nombre}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Grid ColumnDefinitions="*,Auto,Auto" Margin="0,8,0,0">
                        <Label />
                        <Button Grid.Column="1" Text="Guardar" Clicked="OnSave"/>
                        <Button Grid.Column="2" Text="Eliminar" Clicked="OnDelete" IsEnabled="{Binding CanDelete}" Margin="8,0,0,0"/>
                    </Grid>

                    <ActivityIndicator IsRunning="{Binding Busy}" IsVisible="{Binding Busy}" />
                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </Grid>
</ContentPage>