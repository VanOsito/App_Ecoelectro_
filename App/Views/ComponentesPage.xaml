<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:App.Models"
             x:Class="App.Views.ComponentesPage"
             Title="Detecciones de usuarios"
             BackgroundColor="#DCCAE6">

    <Grid RowDefinitions="Auto,*" Padding="8" RowSpacing="8">

        <!-- Fila 0: título + botón exportar -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" ColumnSpacing="8">
            <Label Text="Detecciones de usuarios"
             FontSize="20"
             FontAttributes="Bold"
             VerticalOptions="Center"
             HorizontalOptions="Start" />
            <Button x:Name="btnExportPdf"
              Text="Exportar PDF"
              Clicked="OnExportPdfClicked"
              HeightRequest="40"
              Grid.Column="1"
              HorizontalOptions="End" />
        </Grid>

        <!-- Fila 1: CollectionView ocupa el resto (scrollable) -->
        <CollectionView x:Name="DetectionsList"
                    Grid.Row="1"
                    ItemsSource="{Binding Detections}"
                    EmptyView="No hay detecciones registradas."
                    VerticalOptions="FillAndExpand"
                    Margin="0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:DetectionWithComponents">
                    <Frame Padding="10" Margin="0,6" CornerRadius="8" BorderColor="#E0E0E0" HasShadow="False">
                        <VerticalStackLayout Spacing="8">

                            <Grid ColumnDefinitions="80,*,Auto" RowDefinitions="Auto">
                                <Image Source="{Binding Detection.ImageUrl}" HeightRequest="72" WidthRequest="72" Aspect="AspectFill" Grid.Column="0" />

                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                    <Label Text="{Binding Detection.DispositivoNombre}" FontAttributes="Bold" FontSize="16" TextColor="#7F4A9B" />
                                    <Label Text="{Binding Detection.UsuarioNombre}" FontSize="12" TextColor="Gray" />
                                    <Label Text="{Binding Detection.DetectedAt, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" FontSize="12" TextColor="Gray" />
                                    <Label Text="{Binding Detection.Status}" FontSize="12" TextColor="Gray" />
                                    <Label Text="{Binding Detection.Confidence, StringFormat='Confianza: {0:P1}'}" FontSize="12" TextColor="Gray"
                         IsVisible="{Binding Detection.Confidence, Converter={StaticResource NullToBool}}" />
                                </VerticalStackLayout>

                                <Button Text="Eliminar" Grid.Column="2"
                        VerticalOptions="Start"
                        CommandParameter="{Binding Detection.DetectionId}"
                        Clicked="OnDeleteDetectionClicked" />
                            </Grid>

                            <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                <Label Text="Componentes detectados:" FontAttributes="Italic" FontSize="13" VerticalOptions="Center" TextColor="#7F4A9B"/>
                                <Button Text="Agregar componente"
                        Clicked="OnAddComponentClicked"
                        CommandParameter="{Binding Detection.DetectionId}"
                        HeightRequest="34"
                        FontSize="12"
                        HorizontalOptions="Start" />
                            </HorizontalStackLayout>

                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Components}" Spacing="4">
                                <BindableLayout.ItemTemplate>
                                    <DataTemplate x:DataType="models:ComponentInfo">
                                        <Frame Padding="6" CornerRadius="6" BorderColor="#F0F0F0" HasShadow="False">
                                            <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                                <VerticalStackLayout HorizontalOptions="StartAndExpand">
                                                    <Label Text="{Binding Nombre}" FontAttributes="Bold" TextColor="#7F4A9B" />
                                                    <Label Text="{Binding Estado}" TextColor="Gray" FontSize="12" />
                                                </VerticalStackLayout>

                                                <Button Text="Eliminar componente"
                                Clicked="OnRemoveComponentClicked"
                                BackgroundColor="#E74C3C"
                                TextColor="White"
                                CornerRadius="6"
                                HeightRequest="34" />
                                            </HorizontalStackLayout>
                                        </Frame>
                                    </DataTemplate>
                                </BindableLayout.ItemTemplate>
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

    </Grid>
</ContentPage>