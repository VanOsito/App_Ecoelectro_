<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:App.Models"
             x:Class="App.Views.ComponentesPage"
             Title="Mis detecciones"
             BackgroundColor="#F5F5F5">
  <CollectionView x:Name="DetectionsList"
                  ItemsSource="{Binding Detections}"
                  EmptyView="No hay detecciones registradas."
                  Margin="8">
    <CollectionView.ItemTemplate>
      <DataTemplate x:DataType="models:DetectionWithComponents">
        <Frame Padding="10" Margin="0,6" CornerRadius="8" BorderColor="#E0E0E0" HasShadow="False">
          <VerticalStackLayout Spacing="8">

            <Grid ColumnDefinitions="80,*,Auto" RowDefinitions="Auto">
              <Image Source="{Binding Detection.ImageUrl}" HeightRequest="72" WidthRequest="72" Aspect="AspectFill" Grid.Column="0" />

              <VerticalStackLayout Grid.Column="1" Spacing="2">
                <Label Text="{Binding Detection.DispositivoNombre}" FontAttributes="Bold" FontSize="16" />
                <!-- Nuevo: mostrar usuario propietario (útil para admin) -->
                <Label Text="{Binding Detection.UsuarioNombre}" FontSize="12" TextColor="Gray" />
                <Label Text="{Binding Detection.DetectedAt, StringFormat='{}{0:dd/MM/yyyy HH:mm}'}" FontSize="12" TextColor="Gray" />
                <Label Text="{Binding Detection.Status}" FontSize="12" TextColor="Gray" />
                <Label Text="{Binding Detection.Confidence, StringFormat='Confianza: {0:P1}'}" FontSize="12" TextColor="Gray"
                       IsVisible="{Binding Detection.Confidence, Converter={StaticResource NullToBool}}" />
              </VerticalStackLayout>

              <Button Text="Eliminar" Grid.Column="2"
                      VerticalOptions="Start"
                      CommandParameter="{Binding Detection.DetectionId}"
                      Clicked="OnDeleteDetectionClicked" />
            </Grid>

            <Label Text="Componentes detectados:" FontAttributes="Italic" FontSize="13" />

            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Components}" Spacing="4">
              <BindableLayout.ItemTemplate>
                <DataTemplate x:DataType="models:ComponentInfo">
                  <Frame Padding="6" CornerRadius="6" BorderColor="#F0F0F0" HasShadow="False">
                    <HorizontalStackLayout Spacing="8">
                      <Label Text="{Binding Nombre}" FontAttributes="Bold" />
                      <Label Text="—" />
                      <Label Text="{Binding Estado}" TextColor="Gray" />
                    </HorizontalStackLayout>
                  </Frame>
                </DataTemplate>
              </BindableLayout.ItemTemplate>
            </VerticalStackLayout>

          </VerticalStackLayout>
        </Frame>
      </DataTemplate>
    </CollectionView.ItemTemplate>
  </CollectionView>
</ContentPage>